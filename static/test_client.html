<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Agent</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .tab-buttons { margin: 20px 0; }
        .tab-buttons button { margin-right: 10px; padding: 10px; }
        .tab { display: none; }
        .tab.active { display: block; }
        #log-content, #result-content, #summary-content { 
            background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; white-space: pre-wrap; max-height: 400px; overflow-y: auto; 
        }
        #screenshots-container { display: flex; flex-wrap: wrap; }
        #screenshots img { max-width: 300px; margin: 5px; border: 1px solid #ddd; }
        .stealth-toggle { margin: 10px 0; }
        .stealth-toggle input[type="checkbox"] { width: auto; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Universal Web Agent</h1>
    
    <div class="form-group">
        <label for="url">Target URL</label>
        <input id="url" type="url" value="https://www.amazon.in/" placeholder="https://example.com" />
    </div>
    
    <div class="form-group">
        <label for="query">Your Objective</label>
        <textarea id="query" rows="3">Find the top 5 latest samsung smartphones under 50000 with user ratings above 4 stars</textarea>
    </div>
    
    <div class="form-group">
        <label for="provider">LLM Provider (Vision model recommended)</label>
        <select id="provider">
            <option value="anthropic">Anthropic (Claude 3.5 Sonnet)</option>
            <option value="openai">OpenAI (GPT-4o)</option>
            <option value="groq">Groq (Llama3 - No Vision)</option>
        </select>
    </div>
    
    <div class="stealth-toggle">
        <label>
            <input type="checkbox" id="stealth" /> Enable Stealth Mode (Undetected Playwright) - Use for anti-bot sites
        </label>
    </div>
    
    <button onclick="startJob()">Start Agent</button>

    <div class="tab-buttons">
        <button onclick="showTab('log')">Live Log</button>
        <button onclick="showTab('screenshots')">Screenshots</button>
        <button onclick="showTab('result')">Final JSON Result</button>
        <button onclick="showTab('summary')">Execution Summary</button>
    </div>

    <div id="log" class="tab active">
        <pre id="log-content">Awaiting job start...</pre>
    </div>

    <div id="screenshots" class="tab">
        <div id="screenshots-container">
            <!-- Screenshots will load dynamically here -->
        </div>
    </div>

    <div id="result" class="tab">
        <pre id="result-content">{}</pre>
    </div>

    <div id="summary" class="tab">
        <pre id="summary-content"></pre>
    </div>

    <script>
        let eventSource;
        let jobId;

        function startJob() {
            const url = document.getElementById('url').value;
            const query = document.getElementById('query').value;
            const provider = document.getElementById('provider').value;
            const stealth = document.getElementById('stealth').checked;

            if (!url || !query) {
                alert('Please fill URL and Objective');
                return;
            }

            fetch('/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, query, llm_provider: provider, stealth })
            })
            .then(res => res.json())
            .then(data => {
                jobId = data.job_id;
                appendToLog({ msg: 'Job started with ID: ' + jobId + ' (Stealth: ' + (stealth ? 'Enabled' : 'Disabled') + ')' });
                connectStream(data.stream_url);
            })
            .catch(err => {
                appendToLog({ msg: 'Error starting job: ' + err.message });
            });
        }

        function connectStream(streamUrl) {
            eventSource = new EventSource(streamUrl);
            eventSource.onmessage = function(event) {
                if (event.data === ': keep-alive') return;
                try {
                    const data = JSON.parse(event.data);
                    appendToLog(data);
                    handleEvent(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            eventSource.onerror = function(e) {
                appendToLog({ msg: 'Stream error: ' + e });
                eventSource.close();
            };
        }

        function handleEvent(data) {
            const details = data.details || {};
            switch (data.msg) {
                case 'screenshot_taken':
                    addScreenshot(details.path);
                    break;
                case 'partial_result':
                    updateResult(JSON.stringify(details.items, null, 2));
                    break;
                case 'agent_thought':
                    appendToLog({ msg: 'ðŸ¤– Agent Thought: ' + details.thought });
                    break;
                case 'job_done':
                case 'job_failed':
                    fetchResult();
                    if (eventSource) eventSource.close();
                    if (data.msg === 'job_failed') {
                        alert('Job failed! Check log for details.');
                    }
                    break;
            }
        }

        function appendToLog(data) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerText += `\n[${timestamp}] ${data.msg}`;
            if (data.details) {
                logContent.innerText += '\n' + JSON.stringify(data.details, null, 2);
            }
            logContent.scrollTop = logContent.scrollHeight;
        }

        function addScreenshot(path) {
            const container = document.getElementById('screenshots-container');
            const img = document.createElement('img');
            img.src = '/' + path;
            img.alt = `Step screenshot: ${path}`;
            img.onerror = () => { img.alt = 'Failed to load'; };
            container.appendChild(img);
        }

        function updateResult(content) {
            document.getElementById('result-content').innerText = content;
        }

        function fetchResult() {
            if (!jobId) return;
            fetch(`/result/${jobId}`)
                .then(res => res.json())
                .then(data => {
                    updateResult(JSON.stringify(data.results || [], null, 2));
                    document.getElementById('summary-content').innerText = (data.execution_summary || []).join('\n');
                    if (data.error) {
                        appendToLog({ msg: 'Final error: ' + data.error });
                    }
                    // Load any final screenshots
                    (data.screenshots || []).forEach(path => addScreenshot(path));
                })
                .catch(err => appendToLog({ msg: 'Error fetching result: ' + err }));
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
    </script>
</body>
</html>